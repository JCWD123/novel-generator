# ========================================
# Streamlit 前端 Dockerfile
# ========================================
# 轻量级前端容器
# - Python: 3.10
# - Streamlit + LangChain
# ========================================

# 基础镜像 - Python 3.10 slim
FROM python:3.10-slim

# 设置环境变量
ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8
ENV TZ=Asia/Shanghai

# Python 环境变量
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Streamlit 配置
ENV STREAMLIT_SERVER_PORT=8501
ENV STREAMLIT_SERVER_ADDRESS=0.0.0.0
ENV STREAMLIT_BROWSER_GATHER_USAGE_STATS=false

# ========================================
# 配置国内镜像源
# ========================================
RUN sed -i 's@deb.debian.org@mirrors.aliyun.com@g' /etc/apt/sources.list.d/debian.sources 2>/dev/null || true

# 安装基础依赖
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/*

# 升级 pip 并配置国内镜像源
RUN pip install --upgrade pip setuptools wheel && \
    pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple && \
    pip config set global.trusted-host pypi.tuna.tsinghua.edu.cn

# ========================================
# 安装 Python 依赖
# ========================================
# 安装 Streamlit
RUN pip install streamlit>=1.30.0

# 安装 LangChain
RUN pip install \
    langchain>=0.1.0 \
    langchain-core>=0.1.0 \
    langchain-community>=0.0.20 \
    langchain-openai>=0.0.5

# 安装其他依赖
RUN pip install \
    requests>=2.31.0

# ========================================
# 配置工作目录
# ========================================
WORKDIR /app

# 复制应用代码
COPY config.py /app/
COPY langchain_history.py /app/
COPY vllm_client.py /app/
COPY streamlit_app.py /app/

# 创建历史记录目录
RUN mkdir -p /app/chat_history

# Streamlit 配置文件
RUN mkdir -p /root/.streamlit
COPY streamlit_config.toml /root/.streamlit/config.toml

# 暴露端口
EXPOSE 8501

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8501/_stcore/health || exit 1

# 启动命令
CMD ["streamlit", "run", "streamlit_app.py"]

